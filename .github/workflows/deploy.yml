name: Deploy to VPS with Docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create deployment package
        run: |
          # 1. Create tarball in /tmp (outside current dir) to avoid "file changed" error
          tar -czf /tmp/deploy.tar.gz --exclude='.git' --exclude='.github' .
          
          # 2. Move it back to workspace so scp-action can see it
          mv /tmp/deploy.tar.gz ./deploy.tar.gz

      - name: Upload to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            
            # Define deployment directory
            DEPLOY_DIR="/var/www/tarkaiedtech"
            BACKUP_DIR="/var/www/backups/tarkaiedtech"
            
            echo "ðŸ“¦ Starting deployment..."
            
            # Create directories if they don't exist
            mkdir -p $DEPLOY_DIR
            mkdir -p $BACKUP_DIR
            
            # Backup current deployment
            if [ -d "$DEPLOY_DIR/app" ]; then
              echo "ðŸ’¾ Creating backup..."
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              tar -czf $BACKUP_DIR/backup_$TIMESTAMP.tar.gz -C $DEPLOY_DIR . 2>/dev/null || true
              
              # Keep only last 2 backups
              cd $BACKUP_DIR
              ls -t backup_*.tar.gz | tail -n +3 | xargs -r rm
            fi
            
            # Extract new deployment
            echo "ðŸ“‚ Extracting new deployment..."
            cd /tmp
            tar -xzf deploy.tar.gz -C $DEPLOY_DIR
            rm deploy.tar.gz
            
            # Create .env.production if it doesn't exist
            if [ ! -f "$DEPLOY_DIR/.env.production" ]; then
              echo "ðŸ”§ Creating .env.production from example..."
              cp $DEPLOY_DIR/app/.env.production.example $DEPLOY_DIR/.env.production
              echo "âš ï¸  WARNING: Please update .env.production with actual values!"
            fi
            
            # Navigate to deployment directory
            cd $DEPLOY_DIR
            
            # Stop and remove old containers
            echo "ðŸ›‘ Stopping old containers..."
            docker compose down || true
            
            # Build and start new containers
            echo "ðŸ—ï¸  Building new Docker image..."
            docker compose build --no-cache
            
            echo "ðŸš€ Starting new containers..."
            docker compose up -d
            
            # Wait for health check
            echo "â³ Waiting for application to be healthy..."
            sleep 10
            
            # Check if container is running
            if docker compose ps | grep -q "Up"; then
              echo "âœ… Deployment successful!"
              docker compose ps
            else
              echo "âŒ Deployment failed! Rolling back..."
              docker compose down
              
              # Restore from backup if available
              LATEST_BACKUP=$(ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | head -1)
              if [ -n "$LATEST_BACKUP" ]; then
                echo "ðŸ”„ Restoring from backup: $LATEST_BACKUP"
                tar -xzf $LATEST_BACKUP -C $DEPLOY_DIR
                cd $DEPLOY_DIR
                docker compose up -d
              fi
              
              exit 1
            fi
            
            # Cleanup
            echo "ðŸ§¹ Cleaning up system..."
            
            # 1. Prune Docker Build Cache (Fixes the 11GB usage)
            # -a: Remove all unused build cache, not just dangling ones
            # -f: Force without confirmation
            docker builder prune -af
            
            # 2. Prune Docker Images
            # Removes dangling images (replaced by new builds)
            docker image prune -f
            
            echo "ðŸŽ‰ Deployment complete!"

      - name: Configure Nginx (First time only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # Check if nginx config already exists
            if [ ! -f "/etc/nginx/sites-available/tarkaiedtech" ]; then
              echo "Setting up Nginx configuration..."
              
              cat > /etc/nginx/sites-available/tarkaiedtech << 'EOF'
            # Redirect HTTP to HTTPS
            server {
                listen 80;
                listen [::]:80;
                server_name tarkaiedtech.com www.tarkaiedtech.com;
                
                # For Let's Encrypt verification
                location ^~ /.well-known/acme-challenge/ {
                    root /var/www/certbot;
                }
                
                location / {
                    return 301 https://$server_name$request_uri;
                }
            }

            # HTTPS server
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name tarkaiedtech.com www.tarkaiedtech.com;
                
                # SSL certificates (configure these paths after setting up certbot)
                # ssl_certificate /etc/letsencrypt/live/tarkaiedtech.com/fullchain.pem;
                # ssl_certificate_key /etc/letsencrypt/live/tarkaiedtech.com/privkey.pem;
                
                # Temporarily use HTTP until SSL is configured
                # Comment this out after SSL setup
                listen 80;
                
                # Security headers
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
                
                # Proxy to Next.js app
                location / {
                    proxy_pass http://localhost:5010;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    
                    # Timeouts
                    proxy_connect_timeout 60s;
                    proxy_send_timeout 60s;
                    proxy_read_timeout 60s;
                }
                
                # Cache static assets
                location /_next/static {
                    proxy_pass http://localhost:5010;
                    proxy_cache_valid 60m;
                    add_header Cache-Control "public, immutable";
                }
            }
            EOF
              
              # Enable the site
              ln -sf /etc/nginx/sites-available/tarkaiedtech /etc/nginx/sites-enabled/
              
              # Remove default nginx config if it exists
              rm -f /etc/nginx/sites-enabled/default
              
              # Test and reload nginx
              nginx -t && systemctl reload nginx
              
              echo "âœ… Nginx configured successfully!"
            else
              echo "â„¹ï¸  Nginx already configured, reloading..."
              nginx -t && systemctl reload nginx
            fi

